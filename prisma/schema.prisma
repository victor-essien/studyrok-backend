// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id    String  @id @default(uuid())
  email String  @unique
  name  String
  photo String?
  tier  String  @default("free")

  //Onboarding
  onboarded      Boolean @default(false)
  educationLevel String
  studyGoal      String

  // Gamification
  streak         Int       @default(0)
  longestStreak  Int       @default(0)
  totalStudyTime Int       @default(0) // Total minutes studied
  lastStudyDate  DateTime?

  // AI Usage tracking
  aiRequestsUsed Int      @default(0) // Resets monthly
  aiRequestLimit Int      @default(50) // Based on tier
  lastResetDate  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studyBoards   StudyBoard[]
  flashcardSets FlashcardSet[]
  flashcards    Flashcard[]
  quizzes       Quiz[]
  questions     Question[]
  studySessions StudySession[]
  achievements  Achievement[]
  materials     Material[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model StudyBoard {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  subject     String?
  sourceType  String
  topic       String?

  // Generated Materail (for topic )
  generatedMaterial Json?

  // Uploaded File
  uploadedFile Json?

  // Visual customization
  colorTheme String  @default("purple") // purple, blue, green, orange, red, pink, teal, indigo
  thumbnail  String? // Auto-generated or custom
  emoji      String? // Optional emoji icon

  // Organization
  tags        String[] // ["important", "exam", "chapter-3"]
  isPublic    Boolean   @default(false)
  isFavorite  Boolean   @default(false)
  isArchived  Boolean   @default(false)
  archiveDate DateTime?

  // Statistics
  flashcardsCount Int       @default(0)
  quizzesCount    Int       @default(0)
  videosCount     Int       @default(0)
  totalStudyTime  Int       @default(0) // Minutes spent studying this board
  lastStudiedAt   DateTime?

  // AI Usage
  tokensUsed    Int @default(0)
  aiGenerations Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  flashcardSets FlashcardSet[]
  quizzes       Quiz[]
  studySession  StudySession[]
  materials     Material[]

  @@index([userId])
  @@index([sourceType])
  @@index([createdAt])
  @@index([isArchived])
  @@map("study_boards")
}

model FlashcardSet {
  id           String     @id @default(uuid())
  studyBoardId String
  studyBoard   StudyBoard @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  title            String
  description      String?
  numberOfCards    Int
  difficulty       String // easy, medium, hard, mixed
  generationParams Json?

  // Study progress
  totalReviews  Int       @default(0)
  cardsReviewed Int       @default(0)
  cardsMastered Int       @default(0) // Mastery level >= 4
  averageScore  Float?
  lastStudied   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  flashcards    Flashcard[]
  studySessions StudySession[]

  @@index([studyBoardId])
  @@index([userId])
  @@index([createdAt])
  @@map("flashcard_sets")
}

model Flashcard {
  id             String       @id @default(uuid())
  flashcardSetId String
  flashcardSet   FlashcardSet @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)
  studyBoardId   String
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Card content
  front          String       @db.Text
  back           String       @db.Text
  hint           String?      @db.Text
  image          String? // Optional image URL

  // Card metadata
  difficulty String // "easy", "medium", "hard"
  cardType   String // "basic", "cloze", "image", "reverse"
  tags       String[] // For filtering/organization

  // Spaced Repetition Algorithm (SM-2)
  masteryLevel   Int       @default(0) // 0 = new, 1-5 = learning stages
  easeFactor     Float     @default(2.5) // SM-2 ease factor (1.3 - 2.5+)
  interval       Int       @default(0) // Days until next review
  nextReviewDate DateTime? // When this card should be reviewed
  reviewCount    Int       @default(0) // Total times reviewed
  correctCount   Int       @default(0)
  incorrectCount Int       @default(0)

  // Card history
  lastReviewedAt    DateTime?
  lastReviewQuality Int? // 0-5 (SM-2 quality scale)

  // Ordering
  order Int // Position in the set

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reviews FlashcardReview[]

  @@index([flashcardSetId])
  @@index([userId])
  @@index([nextReviewDate])
  @@index([masteryLevel])
  @@map("flashcards")
}

model FlashcardReview {
  id          String    @id @default(uuid())
  flashcardId String
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  // Review data
  quality    Int // 0-5 (SM-2 scale)
  timeTaken  Int // Seconds taken to review
  wasCorrect Boolean

  // Snapshot of card state at review time
  previousInterval   Int
  newInterval        Int
  previousEaseFactor Float
  newEaseFactor      Float

  reviewedAt DateTime @default(now())

  @@index([flashcardId])
  @@index([reviewedAt])
  @@map("flashcard_reviews")
}

model Quiz {
  id           String     @id @default(uuid())
  studyBoardId String
  studyBoard   StudyBoard @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Quiz details
  title             String
  description       String? @db.Text
  numberOfQuestions Int
  difficulty        String // "easy", "medium", "hard", "mixed"

  // Quiz settings
  timeLimitMinutes  Int? // null = no time limit
  passingScore      Int     @default(70) // Percentage
  shuffleQuestions  Boolean @default(true)
  shuffleOptions    Boolean @default(true)
  showCorrectAnswer Boolean @default(true)

  // Generation parameters
  generationParams Json?
  // Structure: {
  //   questionTypes: ["multiple-choice", "true-false"],
  //   focusAreas: ["Chapter 1", "Chapter 2"]
  // }

  // Completion status
  status           String  @default("not_started") // "not_started", "in_progress", "completed"
  isCompleted      Boolean @default(false)
  score            Float? // Percentage score
  correctAnswers   Int?
  incorrectAnswers Int?
  skippedQuestions Int?

  // Timing
  startedAt        DateTime?
  completedAt      DateTime?
  timeTakenMinutes Int?

  // User answers (stored as JSON for flexibility)
  userAnswers Json?
  // Structure: { "q_1": "answer_a", "q_2": "answer_b", ... }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questions Question[]

  @@index([studyBoardId])
  @@index([userId])
  @@index([isCompleted])
  @@index([createdAt])
  @@map("quizzes")
}

// ============================================
// QUESTION MODEL
// ============================================
model Question {
  id     String @id @default(uuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Question content
  questionType String // "multiple-choice", "true-false", "short-answer", "fill-blank"
  question     String @db.Text

  // Options (for multiple-choice, true-false)
  options       String[] // ["Option A", "Option B", "Option C", "Option D"]
  correctAnswer String   @db.Text

  // Additional info
  explanation String? @db.Text
  hint        String? @db.Text
  image       String? // Optional image URL

  // Scoring
  points     Int    @default(1)
  difficulty String // "easy", "medium", "hard"

  // User response (for this specific quiz attempt)
  userAnswer String?  @db.Text
  isCorrect  Boolean?
  timeTaken  Int? // Seconds

  // Ordering
  order Int // Question order in quiz

  // Timestamps
  createdAt DateTime @default(now())

  @@index([quizId])
  @@index([questionType])
  @@map("questions")
}

model StudySession {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  boardId        String?
  materialId     String?
  studyBoardId   String?
  studyBoard     StudyBoard?   @relation(fields: [studyBoardId], references: [id], onDelete: SetNull)
  flashcardSetId String?
  flashcardSet   FlashcardSet? @relation(fields: [flashcardSetId], references: [id], onDelete: SetNull)

  // Session type
  sessionType String // "flashcards", "quiz", "notes", "video"

  // Session data
  durationMinutes Int
  cardsReviewed   Int?
  correctAnswers  Int?
  totalCards      Int?
  accuracy        Float? // Percentage
  notes           String? // optional summary of what they studied

  material Material? @relation(fields: [materialId], references: [id])

  // Timestamps
  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([studyBoardId])
  @@index([startedAt])
  @@map("study_sessions")
}

model Material {
  id           String @id @default(cuid())
  boardId      String
  userId       String
  studyBoardId String

  title      String
  content    String? // long text or markdown
  type       MaterialType @default(NOTE)
  order      Int? // for sorting inside a board (optional)
  url        String?
  studyBoard StudyBoard   @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  sessions StudySession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studyBoardId])
  @@index([userId])
}

enum MaterialType {
  NOTE
  TOPIC
  SUBTOPIC
  RESOURCE
}

model Achievement {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Achievement details
  type        String // "streak", "cards_reviewed", "quiz_master", "early_bird"
  title       String
  description String
  icon        String // Emoji or icon name
  tier        String // "bronze", "silver", "gold", "platinum"

  // Progress
  current    Int     @default(0)
  target     Int
  isUnlocked Boolean @default(false)

  // Timestamps
  unlockedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([isUnlocked])
  @@map("achievements")
}

model DailyAnalytics {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date

  // Study metrics
  studyTimeMinutes Int    @default(0)
  cardsReviewed    Int    @default(0)
  quizzesCompleted Int    @default(0)
  averageScore     Float?

  // Streaks
  currentStreak Int @default(0)

  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_analytics")
}

model Video {
  id           String @id @default(uuid())
  studyBoardId String
  userId       String

  // Video details
  title       String
  description String? @db.Text
  script      String  @db.Text

  // Video file
  videoUrl        String? // URL to generated video
  thumbnailUrl    String?
  durationSeconds Int?

  // Generation status
  generationStatus String  @default("pending") // "pending", "generating", "completed", "failed"
  generationError  String?

  // Metadata
  voiceType       String? // "male", "female", "neutral"
  backgroundColor String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studyBoardId])
  @@index([userId])
  @@map("videos")
}
