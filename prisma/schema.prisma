generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Session {
  id                 String   @id @default(uuid())
  userId             String
  hashedRefreshToken String
  userAgent          String?
  ip                 String?
  createdAt          DateTime @default(now())
  expiresAt          DateTime
  user               User     @relation(fields: [userId], references: [id])
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  name              String
  photo             String?
  tier              String              @default("free")
  onboarded         Boolean             @default(false)
  educationLevel    String
  studyGoal         String
  streak            Int                 @default(0)
  longestStreak     Int                 @default(0)
  totalStudyTime    Int                 @default(0)
  lastStudyDate     DateTime?
  aiRequestsUsed    Int                 @default(0)
  aiRequestLimit    Int                 @default(50)
  lastResetDate     DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  password          String
  materials         Material[]
  sessions          Session[]
  achievements      Achievement[]
  flashcardSets     FlashcardSet[]
  flashcards        Flashcard[]
  generationHistory GenerationHistory[]
  questions         Question[]
  quizzes           Quiz[]
  studyBoards       StudyBoard[]
  studySessions     StudySession[]
  topics            Topic[]
  progress          UserProgress[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model StudyBoard {
  id              String         @id @default(uuid())
  userId          String
  title           String
  description     String?
  sourceType      String
  colorTheme      String         @default("purple")
  thumbnail       String?
  emoji           String?
  tags            String[]
  isPublic        Boolean        @default(false)
  isFavorite      Boolean        @default(false)
  isArchived      Boolean        @default(false)
  archiveDate     DateTime?
  flashcardsCount Int            @default(0)
  quizzesCount    Int            @default(0)
  videosCount     Int            @default(0)
  totalStudyTime  Int            @default(0)
  lastStudiedAt   DateTime?
  tokensUsed      Int            @default(0)
  aiGenerations   Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  materials       Material[]
  flashcardSets   FlashcardSet[]
  quizzes         Quiz[]
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  studySession    StudySession[]

  @@index([userId])
  @@index([sourceType])
  @@index([createdAt])
  @@index([isArchived])
  @@map("study_boards")
}

model FlashcardSet {
  id               String         @id @default(uuid())
  studyBoardId     String
  userId           String
  title            String
  description      String?
  numberOfCards    Int
  difficulty       String
  generationParams Json?
  totalReviews     Int            @default(0)
  cardsReviewed    Int            @default(0)
  cardsMastered    Int            @default(0)
  averageScore     Float?
  lastStudied      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  studyBoard       StudyBoard     @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcards       Flashcard[]
  studySessions    StudySession[]

  @@index([studyBoardId])
  @@index([userId])
  @@index([createdAt])
  @@map("flashcard_sets")
}

model Flashcard {
  id                String            @id @default(uuid())
  flashcardSetId    String
  studyBoardId      String
  userId            String
  front             String
  back              String
  hint              String?
  image             String?
  difficulty        String
  cardType          String
  tags              String[]
  masteryLevel      Int               @default(0)
  easeFactor        Float             @default(2.5)
  interval          Int               @default(0)
  nextReviewDate    DateTime?
  reviewCount       Int               @default(0)
  correctCount      Int               @default(0)
  incorrectCount    Int               @default(0)
  lastReviewedAt    DateTime?
  lastReviewQuality Int?
  order             Int
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  reviews           FlashcardReview[]
  flashcardSet      FlashcardSet      @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([flashcardSetId])
  @@index([userId])
  @@index([nextReviewDate])
  @@index([masteryLevel])
  @@map("flashcards")
}

model FlashcardReview {
  id                 String    @id @default(uuid())
  flashcardId        String
  quality            Int
  timeTaken          Int
  wasCorrect         Boolean
  previousInterval   Int
  newInterval        Int
  previousEaseFactor Float
  newEaseFactor      Float
  reviewedAt         DateTime  @default(now())
  flashcard          Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@index([flashcardId])
  @@index([reviewedAt])
  @@map("flashcard_reviews")
}

model Quiz {
  id                String     @id @default(uuid())
  studyBoardId      String
  userId            String
  title             String
  description       String?
  numberOfQuestions Int
  difficulty        String
  timeLimitMinutes  Int?
  passingScore      Int        @default(70)
  shuffleQuestions  Boolean    @default(true)
  shuffleOptions    Boolean    @default(true)
  showCorrectAnswer Boolean    @default(true)
  generationParams  Json?
  status            String     @default("not_started")
  isCompleted       Boolean    @default(false)
  score             Float?
  correctAnswers    Int?
  incorrectAnswers  Int?
  skippedQuestions  Int?
  startedAt         DateTime?
  completedAt       DateTime?
  timeTakenMinutes  Int?
  userAnswers       Json?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  questions         Question[]
  studyBoard        StudyBoard @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([studyBoardId])
  @@index([userId])
  @@index([isCompleted])
  @@index([createdAt])
  @@map("quizzes")
}

model Question {
  id            String   @id @default(uuid())
  quizId        String
  userId        String
  questionType  String
  question      String
  options       String[]
  correctAnswer String
  explanation   String?
  hint          String?
  image         String?
  points        Int      @default(1)
  difficulty    String
  userAnswer    String?
  isCorrect     Boolean?
  timeTaken     Int?
  order         Int
  createdAt     DateTime @default(now())
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([questionType])
  @@map("questions")
}

model StudySession {
  id              String        @id @default(uuid())
  userId          String
  boardId         String?
  materialId      String?
  studyBoardId    String?
  flashcardSetId  String?
  sessionType     String
  durationMinutes Int
  cardsReviewed   Int?
  correctAnswers  Int?
  totalCards      Int?
  accuracy        Float?
  notes           String?
  startedAt       DateTime
  endedAt         DateTime
  createdAt       DateTime      @default(now())
  flashcardSet    FlashcardSet? @relation(fields: [flashcardSetId], references: [id])
  material        Material?     @relation(fields: [materialId], references: [id])
  studyBoard      StudyBoard?   @relation(fields: [studyBoardId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([studyBoardId])
  @@index([startedAt])
  @@map("study_sessions")
}

model UploadedNote {
  id               String           @id @default(cuid())
  studyBoardId     String
  userId           String
  fileName         String
  fileType         String
  fileSize         String
  r2Key            String
  r2Url            String
  extractedText    String?
  processingStatus ProcessingStatus @default(PROCESSING)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  material         Material?
}

model Material {
  id              String         @id @default(cuid())
  userId          String
  studyBoardId    String
  title           String
  content         String?
  type            MaterialType
  order           Int?
  url             String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  generatedNoteId String?        @unique
  uploadedNoteId  String?        @unique
  generatedNote   Topic?         @relation("MaterialToTopic", fields: [generatedNoteId], references: [id])
  studyBoard      StudyBoard     @relation(fields: [studyBoardId], references: [id], onDelete: Cascade)
  uploadedNote    UploadedNote?  @relation(fields: [uploadedNoteId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        StudySession[]

  @@index([studyBoardId])
  @@index([userId])
}

model Topic {
  id                String              @id @default(uuid())
  userId            String?             @map("user_id")
  title             String
  description       String?
  subject           String?
  difficulty        Difficulty
  status            TopicStatus         @default(GENERATING)
  totalSections     Int                 @default(0) @map("total_sections")
  totalNotes        Int                 @default(0) @map("total_notes")
  estimatedReadTime Int?                @map("estimated_read_time")
  tags              String[]
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  completedAt       DateTime?           @map("completed_at")
  material          Material?           @relation("MaterialToTopic")
  concepts          Concept[]
  generationHistory GenerationHistory[]
  notes             Note[]
  sections          Section[]
  user              User?               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("topics")
}

model Section {
  id                String        @id @default(uuid())
  topicId           String        @map("topic_id")
  title             String
  description       String?
  orderIndex        Int           @map("order_index")
  depthLevel        DepthLevel    @map("depth_level")
  totalNotes        Int           @default(0) @map("total_notes")
  estimatedReadTime Int?          @map("estimated_read_time")
  status            SectionStatus @default(PENDING)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  completedAt       DateTime?     @map("completed_at")
  notes             Note[]
  topic             Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([topicId, orderIndex])
  @@index([topicId])
  @@map("sections")
}

model Note {
  id                  String             @id @default(uuid())
  sectionId           String             @map("section_id")
  topicId             String             @map("topic_id")
  title               String
  content             String
  summary             String?
  orderIndex          Int                @map("order_index")
  depthLevel          DepthLevel         @map("depth_level")
  wordCount           Int                @map("word_count")
  estimatedReadTime   Int                @map("estimated_read_time")
  includesExamples    Boolean            @default(false) @map("includes_examples")
  includesCode        Boolean            @default(false) @map("includes_code")
  includesDiagrams    Boolean            @default(false) @map("includes_diagrams")
  tags                String[]
  status              NoteStatus         @default(PENDING)
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  concepts            Concept[]
  sourceRelationships NoteRelationship[] @relation("SourceNote")
  targetRelationships NoteRelationship[] @relation("TargetNote")
  section             Section            @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  topic               Topic              @relation(fields: [topicId], references: [id], onDelete: Cascade)
  userProgress        UserProgress[]

  @@unique([sectionId, orderIndex])
  @@index([sectionId])
  @@index([topicId])
  @@map("notes")
}

model GenerationHistory {
  id             String         @id @default(uuid())
  topicId        String         @map("topic_id")
  userId         String?        @map("user_id")
  generationType GenerationType @map("generation_type")
  aiModel        String         @map("ai_model")
  tokensUsed     Int?           @map("tokens_used")
  generationTime Int            @map("generation_time")
  success        Boolean
  errorMessage   String?        @map("error_message")
  createdAt      DateTime       @default(now()) @map("created_at")
  topic          Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id])

  @@index([topicId])
  @@index([userId])
  @@index([createdAt])
  @@map("generation_history")
}

model Concept {
  id         String            @id @default(uuid())
  noteId     String            @map("note_id")
  topicId    String            @map("topic_id")
  term       String
  definition String
  importance ConceptImportance
  createdAt  DateTime          @default(now()) @map("created_at")
  note       Note              @relation(fields: [noteId], references: [id], onDelete: Cascade)
  topic      Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([topicId])
  @@index([term])
  @@map("concepts")
}

model NoteRelationship {
  id               String           @id @default(uuid())
  sourceNoteId     String           @map("source_note_id")
  targetNoteId     String           @map("target_note_id")
  relationshipType RelationshipType @map("relationship_type")
  createdAt        DateTime         @default(now()) @map("created_at")
  sourceNote       Note             @relation("SourceNote", fields: [sourceNoteId], references: [id], onDelete: Cascade)
  targetNote       Note             @relation("TargetNote", fields: [targetNoteId], references: [id], onDelete: Cascade)

  @@unique([sourceNoteId, targetNoteId, relationshipType])
  @@index([sourceNoteId])
  @@index([targetNoteId])
  @@map("note_relationships")
}

model UserProgress {
  id                 String         @id @default(uuid())
  userId             String         @map("user_id")
  noteId             String         @map("note_id")
  status             ProgressStatus
  progressPercentage Int            @default(0) @map("progress_percentage")
  timeSpent          Int            @default(0) @map("time_spent")
  lastAccessed       DateTime?      @map("last_accessed")
  completedAt        DateTime?      @map("completed_at")
  notesUser          String?        @map("notes_user")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  note               Note           @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId])
  @@index([userId])
  @@index([noteId])
  @@map("user_progress")
}

model Achievement {
  id          String    @id @default(uuid())
  userId      String
  type        String
  title       String
  description String
  icon        String
  tier        String
  current     Int       @default(0)
  target      Int
  isUnlocked  Boolean   @default(false)
  unlockedAt  DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isUnlocked])
  @@map("achievements")
}

model DailyAnalytics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime @db.Date
  studyTimeMinutes Int      @default(0)
  cardsReviewed    Int      @default(0)
  quizzesCompleted Int      @default(0)
  averageScore     Float?
  currentStreak    Int      @default(0)
  createdAt        DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_analytics")
}

model Video {
  id               String   @id @default(uuid())
  studyBoardId     String
  userId           String
  title            String
  description      String?
  script           String
  videoUrl         String?
  thumbnailUrl     String?
  durationSeconds  Int?
  generationStatus String   @default("pending")
  generationError  String?
  voiceType        String?
  backgroundColor  String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([studyBoardId])
  @@index([userId])
  @@map("videos")
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MaterialType {
  UPLOADED_NOTE
  GENERATED_TOPIC
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED

  @@map("difficulty")
}

enum TopicStatus {
  GENERATING
  COMPLETED
  FAILED

  @@map("topic_status")
}

enum SectionStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED

  @@map("section_status")
}

enum NoteStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED

  @@map("note_status")
}

enum DepthLevel {
  FOUNDATIONAL
  INTERMEDIATE
  ADVANCED

  @@map("depth_level")
}

enum ConceptImportance {
  CRITICAL
  IMPORTANT
  SUPPLEMENTARY

  @@map("concept_importance")
}

enum RelationshipType {
  PREREQUISITE
  RELATED
  ADVANCED_TOPIC
  SEE_ALSO

  @@map("relationship_type")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  REVIEWED

  @@map("progress_status")
}

enum GenerationType {
  FULL_TOPIC
  SECTION
  NOTE
  REGENERATION

  @@map("generation_type")
}
